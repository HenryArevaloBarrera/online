<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Emociones</title>
<style>
  :root {
    --primary-color: #6a8caf;
    --secondary-color: #8bb3d1;
    --background-color: #f0f4f8;
    --card-color: #ffffff;
    --shadow-color: rgba(0,0,0,0.1);
    --transition-speed: 0.3s;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    gap: 20px;
    padding: 20px;
    transition: background 1s ease;
    overflow-x: hidden;
  }

  .header {
    text-align: center;
    margin-bottom: 10px;
  }

  h1 {
    color: var(--primary-color);
    font-size: 2.5em;
    text-align: center;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    display: inline-block;
  }

  h1::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    border-radius: 2px;
  }

  .subtitle {
    color: #666;
    font-size: 1.1em;
    margin-top: 10px;
  }

  #container {
    position: relative;
    max-width: 720px;
    width: 100%;
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    background: var(--card-color);
    transition: transform var(--transition-speed), box-shadow var(--transition-speed);
  }

  #container:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  }

  video, canvas {
    width: 100%;
    height: auto;
    display: block;
  }

  #overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
  }

  .controls {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    backdrop-filter: blur(5px);
  }

  button {
    padding: 12px 24px;
    border: none;
    border-radius: 50px;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: all var(--transition-speed);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }

  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
  }

  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  button:hover::before {
    left: 100%;
  }

  button:active {
    transform: translateY(1px);
  }

  .status {
    font-size: 16px;
    min-width: 200px;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 10px;
    text-align: center;
    font-weight: 500;
    transition: all var(--transition-speed);
  }

  .status.active {
    background: rgba(106, 140, 175, 0.2);
    color: var(--primary-color);
  }

  .emotion-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    min-width: 250px;
    transition: all var(--transition-speed);
    position: relative;
    overflow: hidden;
  }

  .emotion-display::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.5s ease;
  }

  .emotion-display.active::before {
    transform: scaleX(1);
  }

  .emotion-emoji {
    font-size: 4em;
    transition: transform 0.5s;
    filter: drop-shadow(0 3px 5px rgba(0,0,0,0.2));
  }

  .emotion-emoji.active {
    transform: scale(1.2);
  }

  .emotion-text {
    font-size: 1.5em;
    font-weight: bold;
    color: var(--primary-color);
    text-align: center;
  }

  .emotion-phrase {
    font-size: 1.1em;
    text-align: center;
    font-style: italic;
    color: #666;
    max-width: 300px;
  }

  .color-palette {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    max-width: 600px;
  }

  .color-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    padding: 8px;
    border-radius: 10px;
    transition: all var(--transition-speed);
    cursor: pointer;
  }

  .color-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0,0,0,0.1);
  }

  .color-sample {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .color-name {
    font-size: 0.8em;
    color: #555;
  }

  .note {
    font-size: 14px;
    color: #555;
    text-align: center;
    max-width: 600px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    line-height: 1.5;
  }

  .footer {
    margin-top: 20px;
    font-size: 0.9em;
    color: #777;
    text-align: center;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .pulse {
    animation: pulse 2s infinite;
  }

  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }

  .float {
    animation: float 3s ease-in-out infinite;
  }

  @keyframes emotionChange {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .emotion-change {
    animation: emotionChange 0.5s ease-out;
  }

  @keyframes confetti {
    0% { transform: translateY(0) rotate(0); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }

  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: var(--confetti-color);
    opacity: 0;
    animation: confetti 3s ease-in forwards;
  }

  @media (max-width: 768px) {
    h1 {
      font-size: 2em;
    }
    
    .controls {
      flex-direction: column;
      gap: 10px;
    }
    
    .color-palette {
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Detector de Emociones</h1>
  <div class="subtitle">Descubre tus emociones a trav√©s de los colores</div>
</div>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlayCanvas"></canvas>
</div>

<div class="controls">
  <div class="status" id="status">Iniciando c√°mara...</div>
  <button id="startBtn">Iniciar</button>
  <button id="stopBtn">Detener</button>
</div>

<div class="emotion-display" id="emotionDisplay">
  <div class="emotion-emoji" id="emotionEmoji">üé®</div>
  <div class="emotion-text" id="emotionText">Coloca un color en el c√≠rculo</div>
  <div class="emotion-phrase" id="emotionPhrase"></div>
</div>

<div class="color-palette">
  <div class="color-item">
    <div class="color-sample" style="background-color: #f28b82;"></div>
    <div class="color-name">Enojo</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #81c995;"></div>
    <div class="color-name">Alegr√≠a</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #a7c7e7;"></div>
    <div class="color-name">Calma</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #fff475;"></div>
    <div class="color-name">Energ√≠a</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #ffffff; border: 1px solid #ddd;"></div>
    <div class="color-name">Paz</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #a9a9a9;"></div>
    <div class="color-name">Tristeza</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #f9ab5e;"></div>
    <div class="color-name">Entusiasmo</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #cba0ff;"></div>
    <div class="color-name">Misterio</div>
  </div>
  <div class="color-item">
    <div class="color-sample" style="background-color: #f7a8b8;"></div>
    <div class="color-name">Cari√±o</div>
  </div>
</div>

<div class="note">
  <strong>Instrucciones:</strong> Coloca una tarjeta o color dentro del c√≠rculo central para detectar la emoci√≥n asociada.<br>
  <em>Nota:</em> Necesitas HTTPS o localhost para que la c√°mara funcione correctamente.
</div>

<div class="footer">
  Proyecto de Detector de Emociones | Desarrollado con HTML5, CSS3 y JavaScript
</div>

<script>
const COLOR_WORD_MAP = {
  red: { word:'Enojo', face:'üò†', phrase:'Hoy est√°s enojado, respira profundo', bg:'#f28b82' },
  green: { word:'Alegr√≠a', face:'üòä', phrase:'Se te ve alegre, ¬°genial!', bg:'#81c995' },
  blue: { word:'Calma', face:'üòå', phrase:'Hoy est√°s tranquilo, sigue as√≠', bg:'#a7c7e7' },
  yellow: { word:'Energ√≠a', face:'üòÅ', phrase:'Se nota tu energ√≠a, ¬°qu√© bueno!', bg:'#fff475' },
  white: { word:'Paz', face:'üòá', phrase:'Hoy est√°s en paz, disfruta el momento', bg:'#ffffff' },
  black: { word:'Tristeza', face:'üò¢', phrase:'Hoy est√°s triste, √°nimo, todo pasar√°', bg:'#a9a9a9' },
  orange: { word:'Entusiasmo', face:'ü§©', phrase:'Se nota tu entusiasmo, ¬°brillante!', bg:'#f9ab5e' },
  purple: { word:'Misterio', face:'üßê', phrase:'Hoy hay un toque de misterio, curioso', bg:'#cba0ff' },
  pink: { word:'Cari√±o', face:'ü•∞', phrase:'Hoy sientes cari√±o', bg:'#f7a8b8' }
};

const HSV_RANGES = {
  red: [ [[0,100,50],[10,255,255]], [[160,100,50],[179,255,255]] ],
  green: [ [[35,60,40],[85,255,255]] ],
  blue: [ [[90,50,40],[140,255,255]] ],
  yellow: [ [[20,100,100],[35,255,255]] ],
  white: [ [[0,0,200],[179,40,255]] ],
  black: [ [[0,0,0],[179,255,50]] ],
  orange: [ [[10,100,100],[25,255,255]] ],
  purple: [ [[130,50,50],[160,255,255]] ],
  pink: [ [[160,30,50],[170,255,255]] ]
};

const PERCENT_THRESHOLD = 0.25;
const BOX_W_FRAC = 0.4;
const BOX_H_FRAC = 0.4;

let video = document.getElementById('video');
let overlay = document.getElementById('overlayCanvas');
let statusEl = document.getElementById('status');
let emotionEmoji = document.getElementById('emotionEmoji');
let emotionText = document.getElementById('emotionText');
let emotionPhrase = document.getElementById('emotionPhrase');
let emotionDisplay = document.getElementById('emotionDisplay');
let stream = null;
let rafId = null;
let lastDetected = null;
let speaking = false;

function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), diff=mx-mn;
  let h=0, s=0, v=mx;
  if(diff!==0){
    if(mx===r) h=((g-b)/diff)%6;
    else if(mx===g) h=((b-r)/diff)+2;
    else h=((r-g)/diff)+4;
    h=Math.round(h*60); if(h<0) h+=360;
  }
  s=mx===0?0:diff/mx;
  return [Math.round(h/2), Math.round(s*255), Math.round(v*255)];
}

function inRangeHSV(hsv, low, high){
  const [H,S,V]=hsv;
  return H>=low[0] && H<=high[0] && S>=low[1] && S<=high[1] && V>=low[2] && V<=high[2];
}

function detectColor(imageData, box){
  const {data,width,height}=imageData;
  const x1=Math.max(0,Math.floor(box.x));
  const y1=Math.max(0,Math.floor(box.y));
  const x2=Math.min(width,Math.floor(box.x+box.w));
  const y2=Math.min(height,Math.floor(box.y+box.h));
  const total=(y2-y1)*(x2-x1);
  if(total<=0) return {color:null, ratio:0};
  const counts={}; for(const c in HSV_RANGES) counts[c]=0;

  for(let yy=y1;yy<y2;yy++){
    for(let xx=x1;xx<x2;xx++){
      const idx=(yy*width+xx)*4;
      const r=data[idx], g=data[idx+1], b=data[idx+2];
      const hsv=rgbToHsv(r,g,b);
      for(const [color,ranges] of Object.entries(HSV_RANGES)){
        for(const rng of ranges){
          const [low,high]=rng;
          if(inRangeHSV(hsv,low,high)){ counts[color]++; break; }
        }
      }
    }
  }

  let best=null, ratio=0;
  for(const [c,count] of Object.entries(counts)){
    const r=count/total;
    if(r>ratio){ ratio=r; best=c; }
  }
  return ratio>=PERCENT_THRESHOLD ? {color:best, ratio} : {color:null, ratio};
}

// Dibujar overlay circular sin ojos
function drawOverlay(ctx, box, detected){
  const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);

  // Fondo semi-transparente
  ctx.fillStyle='rgba(255,255,255,0.2)';
  ctx.fillRect(0,0,W,H);

  // Zona circular
  const cx=box.x+box.w/2;
  const cy=box.y+box.h/2;
  const radius=box.w/2;
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx,cy,radius,0,2*Math.PI);
  ctx.clip();

  ctx.drawImage(video,0,0,W,H);
  ctx.restore();

  // Dibujar c√≠rculo borde con efecto de brillo
  ctx.beginPath();
  ctx.arc(cx,cy,radius,0,2*Math.PI);
  ctx.strokeStyle='#6a8caf'; 
  ctx.lineWidth=4;
  ctx.stroke();
  
  // Efecto de brillo interior
  ctx.beginPath();
  ctx.arc(cx,cy,radius-2,0,2*Math.PI);
  ctx.strokeStyle='rgba(255,255,255,0.5)'; 
  ctx.lineWidth=2;
  ctx.stroke();

  // Emoji y texto
  ctx.font=`bold ${Math.round(Math.min(W,H)*0.08)}px sans-serif`;
  ctx.textAlign='center'; 
  ctx.textBaseline='middle';
  const face = detected.color && COLOR_WORD_MAP[detected.color]? COLOR_WORD_MAP[detected.color].face:'‚ùì';
  ctx.fillText(face, cx, cy);

  ctx.font=`${Math.round(Math.min(W,H)*0.05)}px sans-serif`;
  ctx.fillStyle='#333';
  const label = detected.color ? COLOR_WORD_MAP[detected.color].word : 'DESCONOCIDO';
  ctx.fillText(label, cx, cy+radius*0.7);
}

function createConfetti(color) {
  const colors = ['#f28b82', '#81c995', '#a7c7e7', '#fff475', '#f9ab5e', '#cba0ff', '#f7a8b8'];
  const confettiColor = color || colors[Math.floor(Math.random() * colors.length)];
  
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.setProperty('--confetti-color', confettiColor);
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.top = '-10px';
    confetti.style.width = Math.random() * 10 + 5 + 'px';
    confetti.style.height = Math.random() * 10 + 5 + 'px';
    confetti.style.animationDelay = Math.random() * 2 + 's';
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 3000);
  }
}

function updateEmotionDisplay(detected) {
  if (detected.color && COLOR_WORD_MAP[detected.color]) {
    const emotion = COLOR_WORD_MAP[detected.color];
    emotionEmoji.textContent = emotion.face;
    emotionText.textContent = emotion.word;
    emotionPhrase.textContent = emotion.phrase;
    
    // A√±adir animaci√≥n
    emotionEmoji.classList.add('emotion-change');
    emotionDisplay.classList.add('active');
    
    setTimeout(() => {
      emotionEmoji.classList.remove('emotion-change');
    }, 500);
    
    // Cambiar color de fondo del display
    emotionDisplay.style.background = `rgba(${parseInt(emotion.bg.slice(1,3), 16)}, ${parseInt(emotion.bg.slice(3,5), 16)}, ${parseInt(emotion.bg.slice(5,7), 16)}, 0.2)`;
    
    // Crear confetti para emociones positivas
    if (['green', 'yellow', 'orange', 'pink'].includes(detected.color)) {
      createConfetti(emotion.bg);
    }
  } else {
    emotionEmoji.textContent = 'üé®';
    emotionText.textContent = 'Coloca un color en el c√≠rculo';
    emotionPhrase.textContent = '';
    emotionDisplay.style.background = 'rgba(255, 255, 255, 0.8)';
    emotionDisplay.classList.remove('active');
  }
}

function getFriendlyVoice() {
  const voices = window.speechSynthesis.getVoices();
  const friendly = voices.find(v => v.lang.startsWith('es') && v.name.toLowerCase().includes('female'));
  return friendly || voices[0];
}

function speakPhrase(text){
  if(!text || speaking) return;
  speaking=true;
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = getFriendlyVoice();
  utter.lang='es-ES';
  utter.pitch=1.3;
  utter.rate=0.95;
  utter.volume=1.0;
  utter.onend=()=>{ speaking=false; lastDetected=null; };
  window.speechSynthesis.speak(utter);
}

async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    statusEl.textContent='C√°mara activa';
    statusEl.classList.add('active');
    await new Promise(r=>video.onloadedmetadata=r);
    overlay.width=video.videoWidth;
    overlay.height=video.videoHeight;
    overlay.style.width=video.clientWidth+'px';
    overlay.style.height=video.clientHeight+'px';
    loop();
  }catch(err){
    console.error(err);
    statusEl.textContent='Error al abrir la c√°mara: '+err.message;
    statusEl.style.background = 'rgba(255, 0, 0, 0.1)';
  }
}

function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(rafId) cancelAnimationFrame(rafId);
  statusEl.textContent='C√°mara detenida';
  statusEl.classList.remove('active');
  emotionEmoji.textContent = 'üé®';
  emotionText.textContent = 'C√°mara detenida';
  emotionPhrase.textContent = '';
  emotionDisplay.style.background = 'rgba(255, 255, 255, 0.8)';
  emotionDisplay.classList.remove('active');
}

function loop(){
  const ctx=overlay.getContext('2d');
  const tmp=document.createElement('canvas');
  tmp.width=video.videoWidth;
  tmp.height=video.videoHeight;
  const tctx=tmp.getContext('2d');

  function frame(){
    if(!stream) return;
    tctx.drawImage(video,0,0,tmp.width,tmp.height);
    const box_w=Math.round(tmp.width*BOX_W_FRAC);
    const box_h=Math.round(tmp.height*BOX_H_FRAC);
    const box_x=Math.round((tmp.width-box_w)/2);
    const box_y=Math.round((tmp.height-box_h)/2);
    const box={x:box_x,y:box_y,w:box_w,h:box_h};

    const imageData=tctx.getImageData(0,0,tmp.width,tmp.height);
    const detected=detectColor(imageData, box);
    drawOverlay(ctx, box, detected);
    
    // Actualizar display de emociones
    updateEmotionDisplay(detected);

    if(detected.color && COLOR_WORD_MAP[detected.color]){
      document.body.style.background = COLOR_WORD_MAP[detected.color].bg;
    }

    if(detected.color && !speaking && detected.color!==lastDetected){
      lastDetected=detected.color;
      speakPhrase(COLOR_WORD_MAP[detected.color].phrase);
    }

    rafId=requestAnimationFrame(frame);
  }
  frame();
}

document.getElementById('startBtn').addEventListener('click', ()=>{ if(!stream) startCamera(); });
document.getElementById('stopBtn').addEventListener('click', ()=>stopCamera());

// Iniciar c√°mara autom√°ticamente al cargar la p√°gina
window.addEventListener('load', () => {
  startCamera();
});

window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
