<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Detector de emociones - versi√≥n moderna</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    margin: 0;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 12px;
  }
  h2 { color: #2d7; }
  #container {
    position: relative;
    max-width: 900px;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 20px #2d7;
  }
  video, canvas { width: 100%; height: auto; display: block; }
  #overlayCanvas { position: absolute; top: 0; left: 0; }
  .controls { display: flex; gap: 8px; margin-top: 8px; }
  button {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    background: #2d7;
    color: #111;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  button:hover { background: #39f; color: #fff; }
  .status { font-size: 18px; min-width: 200px; }
  .note { font-size: 13px; color: #ccc; max-width: 600px; text-align: center; }
</style>
</head>
<body>

<h2>Detector de emociones moderno üòÉ</h2>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlayCanvas"></canvas>
</div>

<div class="controls">
  <div class="status" id="status">Iniciando c√°mara...</div>
  <button id="startBtn">Iniciar</button>
  <button id="stopBtn">Detener</button>
</div>

<div class="note">
  Coloca una tarjeta o muestra un color dentro del recuadro central.<br>
  Necesitas HTTPS o localhost para que la c√°mara funcione.
</div>

<script>
const COLOR_WORD_MAP = {
  red: { word: 'ENOJO', face: 'üò†' },
  green: { word: 'ALEGRE', face: 'üòä' },
  blue: { word: 'CALMA', face: 'üòå' },
  yellow: { word: 'ENERG√çA', face: 'üòÅ' },
  white: { word: 'PAZ', face: 'üòá' },
  black: { word: 'TRISTEZA', face: 'üò¢' }
};

const HSV_RANGES = {
  red: [ [[0,100,50],[10,255,255]], [[160,100,50],[179,255,255]] ],
  green: [ [[35,60,40],[85,255,255]] ],
  blue: [ [[90,50,40],[140,255,255]] ],
  yellow: [ [[20,100,100],[35,255,255]] ],
  white: [ [[0,0,200],[179,40,255]] ],
  black: [ [[0,0,0],[179,255,50]] ]
};

const PERCENT_THRESHOLD = 0.25;
const BOX_W_FRAC = 0.4;
const BOX_H_FRAC = 0.4;

let video = document.getElementById('video');
let overlay = document.getElementById('overlayCanvas');
let statusEl = document.getElementById('status');

let stream = null;
let rafId = null;
let lastDetected = null;
let lastSpeakTime = 0;

function rgbToHsv(r,g,b){
  r/=255; g/=255; b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), diff=mx-mn;
  let h=0, s=0, v=mx;
  if(diff!==0){
    if(mx===r) h=( (g-b)/diff )%6;
    else if(mx===g) h=( (b-r)/diff )+2;
    else h=( (r-g)/diff )+4;
    h=Math.round(h*60); if(h<0) h+=360;
  }
  s=mx===0?0:diff/mx;
  return [Math.round(h/2), Math.round(s*255), Math.round(v*255)];
}

function inRangeHSV(hsv, low, high){
  const [H,S,V]=hsv;
  return H>=low[0] && H<=high[0] && S>=low[1] && S<=high[1] && V>=low[2] && V<=high[2];
}

function detectColor(imageData, box){
  const {data,width,height} = imageData;
  const x1=Math.max(0,Math.floor(box.x));
  const y1=Math.max(0,Math.floor(box.y));
  const x2=Math.min(width,Math.floor(box.x+box.w));
  const y2=Math.min(height,Math.floor(box.y+box.h));
  const total=(y2-y1)*(x2-x1);
  if(total<=0) return {color:null, ratio:0};
  const counts={}; for(const c in HSV_RANGES) counts[c]=0;

  for(let yy=y1;yy<y2;yy++){
    for(let xx=x1;xx<x2;xx++){
      const idx=(yy*width+xx)*4;
      const r=data[idx], g=data[idx+1], b=data[idx+2];
      const hsv=rgbToHsv(r,g,b);
      for(const [color,ranges] of Object.entries(HSV_RANGES)){
        for(const rng of ranges){
          const [low,high]=rng;
          if(inRangeHSV(hsv,low,high)){ counts[color]++; break; }
        }
      }
    }
  }

  let best=null, ratio=0;
  for(const [c,count] of Object.entries(counts)){
    const r=count/total;
    if(r>ratio){ ratio=r; best=c; }
  }
  return ratio>=PERCENT_THRESHOLD ? {color:best, ratio} : {color:null, ratio};
}

function drawOverlay(ctx, box, detected){
  const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='rgba(0,0,0,0.5)';
  ctx.fillRect(0,0,W,H);
  ctx.clearRect(box.x, box.y, box.w, box.h);
  ctx.strokeStyle='white'; ctx.lineWidth=Math.max(2, Math.round(Math.min(W,H)*0.004));
  ctx.strokeRect(box.x, box.y, box.w, box.h);

  ctx.font=`${Math.round(Math.min(W,H)*0.08)}px sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  const face = detected.color && COLOR_WORD_MAP[detected.color]? COLOR_WORD_MAP[detected.color].face:'‚ùì';
  ctx.fillText(face, box.x+box.w/2, box.y+box.h/2);

  ctx.font=`${Math.round(Math.min(W,H)*0.04)}px sans-serif`;
  ctx.fillStyle='white';
  const label = detected.color ? COLOR_WORD_MAP[detected.color].word : 'DESCONOCIDO';
  ctx.fillText(label, box.x+box.w/2, box.y+box.h+30);
}

function speak(text){
  if(!text) return;
  const now=Date.now();
  if(now-lastSpeakTime<2000) return; // espera 2s entre palabras
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang='es-ES';
  window.speechSynthesis.speak(utter);
  lastSpeakTime=now;
}

async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject=stream;
    statusEl.textContent='C√°mara activa';
    await new Promise(r=>video.onloadedmetadata=r);
    overlay.width=video.videoWidth;
    overlay.height=video.videoHeight;
    overlay.style.width=video.clientWidth+'px';
    overlay.style.height=video.clientHeight+'px';
    loop();
  }catch(err){
    console.error(err);
    statusEl.textContent='Error al abrir la c√°mara: '+err.message;
  }
}

function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(rafId) cancelAnimationFrame(rafId);
  statusEl.textContent='C√°mara detenida';
}

function loop(){
  const ctx=overlay.getContext('2d');
  const tmp=document.createElement('canvas');
  tmp.width=video.videoWidth; tmp.height=video.videoHeight;
  const tctx=tmp.getContext('2d');

  function frame(){
    if(!stream) return;
    tctx.drawImage(video,0,0,tmp.width,tmp.height);
    const box_w=Math.round(tmp.width*BOX_W_FRAC);
    const box_h=Math.round(tmp.height*BOX_H_FRAC);
    const box_x=Math.round((tmp.width-box_w)/2);
    const box_y=Math.round((tmp.height-box_h)/2);
    const box={x:box_x,y:box_y,w:box_w,h:box_h};

    const imageData=tctx.getImageData(0,0,tmp.width,tmp.height);
    const detected=detectColor(imageData, box);
    drawOverlay(ctx, box, detected);

    if(detected.color!==lastDetected){
      lastDetected=detected.color;
      if(detected.color) speak(COLOR_WORD_MAP[detected.color].word);
    }

    rafId=requestAnimationFrame(frame);
  }
  frame();
}

document.getElementById('startBtn').addEventListener('click', ()=>{ if(!stream) startCamera(); });
document.getElementById('stopBtn').addEventListener('click', ()=>stopCamera());
startCamera();
window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
